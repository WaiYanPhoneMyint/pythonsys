{% extends 'base.html' %}
{% block title %}Home{% endblock %}
{% block content %}
<h2>User Data</h2>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}


<!-- {% if session.get('user_id') %}
<div class="alert alert-info alert-dismissible fade show" role="alert">
  Welcome back, admin!
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %} -->

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
  <div class="d-flex align-items-center mb-2 mb-md-0">
    <label for="entries" class="me-2">Show</label>
    <select class="form-select form-select-sm" id="entries" style="width: auto;">
      <option value="10" selected>10</option>
      <option value="50">50</option>
      <option value="100">100</option>
      <option value="all">All</option>
    </select>
    <span class="ms-2">entries</span>
  </div>
  <div class="d-flex align-items-center">
    <input type="text" class="form-control me-2" id="searchUsername" placeholder="Search"
      style="min-width: 180px;">
    <button class="btn btn-primary text-nowrap" data-bs-toggle="modal" data-bs-target="#addUserModal">
      <i class="bi bi-person-plus"></i> Add New
    </button>
  </div>
</div>

<table class="table table-hover table-bordered">
  <thead>
    <tr>
      <th>UID</th>
      <th>UserName</th>
      <th>Contact</th>
      <th>Role</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="userTableBody">
    {% for user in users %}
    <tr>
      <td>{{ user.id }}</td>
      <td>{{ user.username }}</td>
      <td>{{ user.contact }}</td>
      <td>
        {% if user.role == 'Vip' %}
        <span class="badge bg-primary">Vip</span>
        {% elif user.role == 'Premium' %}
        <span class="badge bg-warning text-dark">Premium</span>
        {% elif user.role == 'Crown' %}
        <span class="badge bg-success">Crown</span>
        {% else %}
        <span class="badge bg-secondary">{{ user.role }}</span>
        {% endif %}
      </td>
      <td>
        <button class="btn btn-sm btn-warning me-1" data-bs-toggle="modal" data-bs-target="#editUserModal"
          data-user-id="{{ user.id }}">
          <i class="bi bi-pencil-square"></i>
        </button>
        <form method="POST" action="{{ url_for('delete_user', user_id=user.id) }}" style="display:inline;">
          <button type="submit" class="btn btn-sm btn-danger"
            onclick="return confirm('Are you sure you want to delete this user?');">
            <i class="bi bi-trash"></i>
          </button>
        </form>

      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<nav>
  <ul class="pagination justify-content-center" id="pagination"></ul>
</nav>

<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="addUserModalBody">
        <p>Loading form...</p>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="editUserModalBody">
        <p>Loading user data...</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Add User Modal
    const addUserModal = document.getElementById('addUserModal');
    if (addUserModal) {
      const modalBody = document.getElementById('addUserModalBody');
      addUserModal.addEventListener('show.bs.modal', function () {
        fetch("{{ url_for('add_user_form') }}")
          .then(res => res.ok ? res.text() : Promise.reject())
          .then(html => modalBody.innerHTML = html)
          .catch(() => modalBody.innerHTML = '<p class="text-danger">Error loading form. Please try again.</p>');
      });
    }

    // Edit User Modal
    const editUserModal = document.getElementById('editUserModal');
    if (editUserModal) {
      editUserModal.addEventListener('show.bs.modal', function (event) {
        let button = event.relatedTarget;
        if (!button) {
          // Fallback: find the last focused button with data-user-id
          button = document.querySelector('button[data-user-id]:focus');
        }
        if (!button) return;
        const userId = button.getAttribute('data-user-id');
        const modalBody = document.getElementById('editUserModalBody');
        fetch(`/edit-user-form/${userId}`)
          .then(response => response.text())
          .then(html => {
            modalBody.innerHTML = html;
          })
          .catch(() => {
            modalBody.innerHTML = '<p class="text-danger">Error loading form.</p>';
          });
      });
    }

    // Entries dropdown logic
    const entriesSelect = document.getElementById('entries');
    const tableBody = document.getElementById('userTableBody');
    const allRows = Array.from(tableBody.querySelectorAll('tr'));

    function updateTableDisplay(limit) {
      allRows.forEach((row, index) => {
        row.style.display = (limit === 'all' || index < limit) ? '' : 'none';
      });
    }

    entriesSelect.addEventListener('change', function () {
      const value = this.value;
      updateTableDisplay(value === 'all' ? 'all' : parseInt(value));
    });

    // Initial load
    updateTableDisplay(entriesSelect.value === 'all' ? 'all' : parseInt(entriesSelect.value));

    // Pagination logic with prev/next/first/last
    const tableBodyPag = document.getElementById('userTableBody');
    const rowsPag = Array.from(tableBodyPag.querySelectorAll('tr'));
    const pagination = document.getElementById('pagination');
    let rowsPerPage = entriesSelect.value === 'all' ? 'all' : parseInt(entriesSelect.value) || 10;
    let currentPage = 1;

    function showPage(page) {
      if (rowsPerPage === 'all') {
        rowsPag.forEach(row => row.style.display = '');
        renderPagination(1, 1);
        return;
      }
      const totalPages = Math.ceil(rowsPag.length / rowsPerPage);
      currentPage = Math.max(1, Math.min(page, totalPages));
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      rowsPag.forEach((row, index) => {
        row.style.display = (index >= start && index < end) ? '' : 'none';
      });
      renderPagination(currentPage, totalPages);
    }

    function renderPagination(currentPage, totalPages) {
      pagination.innerHTML = '';
      if (rowsPerPage === 'all' || totalPages <= 1) return;
      // First
      const firstLi = document.createElement('li');
      firstLi.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
      firstLi.innerHTML = `<a class="page-link" href="#">&laquo;</a>`;
      firstLi.addEventListener('click', function (e) {
        e.preventDefault();
        if (currentPage > 1) showPage(1);
      });
      pagination.appendChild(firstLi);
      // Prev
      const prevLi = document.createElement('li');
      prevLi.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
      prevLi.innerHTML = `<a class="page-link" href="#">&lt;</a>`;
      prevLi.addEventListener('click', function (e) {
        e.preventDefault();
        if (currentPage > 1) showPage(currentPage - 1);
      });
      pagination.appendChild(prevLi);
      // Page numbers (show max 5, with ellipsis)
      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, currentPage + 2);
      if (currentPage <= 3) endPage = Math.min(5, totalPages);
      if (currentPage >= totalPages - 2) startPage = Math.max(1, totalPages - 4);
      if (startPage > 1) {
        const li = document.createElement('li');
        li.className = 'page-item disabled';
        li.innerHTML = `<span class="page-link">...</span>`;
        pagination.appendChild(li);
      }
      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === currentPage ? ' active' : '');
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.addEventListener('click', function (e) {
          e.preventDefault();
          showPage(i);
        });
        pagination.appendChild(li);
      }
      if (endPage < totalPages) {
        const li = document.createElement('li');
        li.className = 'page-item disabled';
        li.innerHTML = `<span class="page-link">...</span>`;
        pagination.appendChild(li);
      }
      // Next
      const nextLi = document.createElement('li');
      nextLi.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
      nextLi.innerHTML = `<a class="page-link" href="#">&gt;</a>`;
      nextLi.addEventListener('click', function (e) {
        e.preventDefault();
        if (currentPage < totalPages) showPage(currentPage + 1);
      });
      pagination.appendChild(nextLi);
      // Last
      const lastLi = document.createElement('li');
      lastLi.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
      lastLi.innerHTML = `<a class="page-link" href="#">&raquo;</a>`;
      lastLi.addEventListener('click', function (e) {
        e.preventDefault();
        if (currentPage < totalPages) showPage(totalPages);
      });
      pagination.appendChild(lastLi);
    }

    entriesSelect.addEventListener('change', function () {
      rowsPerPage = this.value === 'all' ? 'all' : parseInt(this.value);
      showPage(1);
    });

    showPage(1); // Initialize
  });

  document.getElementById('searchUsername').addEventListener('input', function () {
    const keyword = this.value.toLowerCase();
    const rows = document.querySelectorAll('#userTableBody tr');

    rows.forEach(row => {
      const username = row.cells[1].textContent.toLowerCase();
      row.style.display = username.includes(keyword) ? '' : 'none';
    });
  });

</script>
{% endblock %}